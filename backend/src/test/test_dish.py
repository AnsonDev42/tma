from dotenv import load_dotenv
from fastapi.testclient import TestClient

from src.models import Dish
from src.services.utils import build_search_chain
from src.main import app
import pytest


pytest_plugins = ("pytest_asyncio",)
client = TestClient(app)
load_dotenv("../../.env")  # This will load the .env file automatically if present


@pytest.mark.asyncio
async def test_FatSerectClient():
    from src.core.vendors.fatsecret.client import FatSecretClient

    fatsecret = FatSecretClient()
    res = await fatsecret.search_food("korean fried chicken")
    assert res is not None
    assert len(res) > 0
    """
    {'foods': {'food': [{'food_description': 'Per 2152g - Calories: 6198kcal | Fat: 387.48g | Carbs: 295.36g | Protein: 353.75g', 'food_id': '5493411', 'food_name': 'Korean Fried Chicken', 'food_type': 'Generic', 'food_url': 'https://www.fatsecret.com/calories-nutrition/generic/korean-fried-chicken'}, {'food_description': 'Per 100g - Calories: 218kcal | Fat: 10.30g | Carbs: 1.18g | Protein: 28.18g', 'food_id': '34482', 'food_name': 'Chicken Thigh Meat (Broilers or Fryers, Flour, Fried, Cooked)', 'food_type': 'Generic', 'food_url': 'https://www.fatsecret.com/calories-nutrition/usda/chicken-thigh-meat-(broilers-or-fryers-flour-fried-cooked)'}, {'food_description': 'Per 100g - Calories: 254kcal | Fat: 14.43g | Carbs: 2.50g | Protein: 26.84g', 'food_id': '34462', 'food_name': 'Chicken Leg Meat and Skin (Broilers or Fryers, Flour, Fried, Cooked)', 'food_type': 'Generic', 'food_url': 'https://www.fatsecret.com/calories-nutrition/usda/chicken-leg-meat-and-skin-(broilers-or-fryers-flour-fried-cooked)'}, {'brand_name': 'Signature Select', 'food_description': 'Per 1 bowl - Calories: 340kcal | Fat: 6.00g | Carbs: 56.00g | Protein: 11.00g', 'food_id': '32164532', 'food_name': 'Korean Style Fried Chicken Rice Bowl', 'food_type': 'Brand', 'food_url': 'https://www.fatsecret.com/calories-nutrition/signature-select/korean-style-fried-chicken-rice-bowl'}, {'food_description': 'Per 100g - Calories: 229kcal | Fat: 11.88g | Carbs: 1.77g | Protein: 26.87g', 'food_id': '34474', 'food_name': 'Chicken Neck Meat (Broilers or Fryers, Fried, Cooked)', 'food_type': 'Generic', 'food_url': 'https://www.fatsecret.com/calories-nutrition/usda/chicken-neck-meat-(broilers-or-fryers-fried-cooked)'}, {'food_description': 'Per 104g - Calories: 329kcal | Fat: 23.43g | Carbs: 0.00g | Protein: 27.98g', 'food_id': '1723', 'food_name': 'Fried Chicken Wing No Coating (Skin Eaten)', 'food_type': 'Generic', 'food_url': 'https://www.fatsecret.com/calories-nutrition/generic/chicken-wing-fried-no-coating-skin-eaten'}, {'brand_name': 'Cheesecake Factory', 'food_description': 'Per 1 serving - Calories: 1810kcal | Fat: 72.00g | Carbs: 239.00g | Protein: 51.00g', 'food_id': '60480151', 'food_name': 'Korean Fried Chicken', 'food_type': 'Brand', 'food_url': 'https://www.fatsecret.com/calories-nutrition/cheesecake-factory/korean-fried-chicken'}, {'food_description': 'Per 129g - Calories: 329kcal | Fat: 12.15g | Carbs: 22.81g | Protein: 29.99g', 'food_id': '2810', 'food_name': 'Breaded Fried Chicken Fillet Sandwich', 'food_type': 'Generic', 'food_url': 'https://www.fatsecret.com/calories-nutrition/generic/chicken-fillet-(breaded-fried)-sandwich'}, {'brand_name': 'Golden Corral', 'food_description': 'Per 1 serving - Calories: 1950kcal | Fat: 81.00g | Carbs: 185.00g | Protein: 111.00g', 'food_id': '74855170', 'food_name': 'Korean Style Fried Chicken - Homeward 18 oz (4 Pieces)', 'food_type': 'Brand', 'food_url': 'https://www.fatsecret.com/calories-nutrition/golden-corral/korean-style-fried-chicken-homeward-18-oz-(4-pieces)'}, {'food_description': 'Per 102g - Calories: 264kcal | Fat: 15.59g | Carbs: 0.00g | Protein: 29.07g', 'food_id': '1633', 'food_name': 'Fried Chicken No Coating (Skin Eaten)', 'food_type': 'Generic', 'food_url': 'https://www.fatsecret.com/calories-nutrition/generic/chicken-fried-no-coating-skin-eaten'}, {'food_description': 'Per 100g - Calories: 262kcal | Fat: 14.98g | Carbs: 3.18g | Protein: 26.75g', 'food_id': '34478', 'food_name': 'Chicken Thigh Meat and Skin (Broilers or Fryers, Flour, Fried, Cooked)', 'food_type': 'Generic', 'food_url': 'https://www.fatsecret.com/calories-nutrition/usda/chicken-thigh-meat-and-skin-(broilers-or-fryers-flour-fried-cooked)'}, {'food_description': 'Per 100g - Calories: 234kcal | Fat: 12.77g | Carbs: 8.51g | Protein: 21.28g', 'food_id': '3326', 'food_name': 'Fried Breaded Meatless Chicken', 'food_type': 'Generic', 'food_url': 'https://www.fatsecret.com/calories-nutrition/generic/chicken-meatless-breaded-fried'}, {'food_description': 'Per 103g - Calories: 241kcal | Fat: 10.17g | Carbs: 9.97g | Protein: 25.73g', 'food_id': '1656', 'food_name': 'Baked or Fried Coated Chicken Breast Skinless', 'food_type': 'Generic', 'food_url': 'https://www.fatsecret.com/calories-nutrition/generic/chicken-breast-coated-baked-or-fried-prepared-skinless'}, {'food_description': 'Per 1014g - Calories: 1683kcal | Fat: 61.24g | Carbs: 214.14g | Protein: 63.78g', 'food_id': '5100', 'food_name': 'Chicken Fried Rice', 'food_type': 'Generic', 'food_url': 'https://www.fatsecret.com/calories-nutrition/generic/rice-fried-with-chicken'}, {'food_description': 'Per 100g - Calories: 273kcal | Fat: 16.17g | Carbs: 8.72g | Protein: 21.77g', 'food_id': '34461', 'food_name': 'Chicken Leg Meat and Skin (Broilers or Fryers, Batter, Fried, Cooked)', 'food_type': 'Generic', 'food_url': 'https://www.fatsecret.com/calories-nutrition/usda/chicken-leg-meat-and-skin-(broilers-or-fryers-batter-fried-cooked)'}, {'food_description': 'Per 102g - Calories: 264kcal | Fat: 15.59g | Carbs: 0.00g | Protein: 29.07g', 'food_id': '1632', 'food_name': 'Fried Chicken No Coating', 'food_type': 'Generic', 'food_url': 'https://www.fatsecret.com/calories-nutrition/generic/chicken-fried-no-coating-ns-as-to-skin-eaten'}, {'food_description': 'Per 100g - Calories: 324kcal | Fat: 21.81g | Carbs: 10.94g | Protein: 19.87g', 'food_id': '34486', 'food_name': 'Chicken Wing Meat and Skin (Broilers or Fryers, Batter, Fried, Cooked)', 'food_type': 'Generic', 'food_url': 'https://www.fatsecret.com/calories-nutrition/usda/chicken-wing-meat-and-skin-(broilers-or-fryers-batter-fried-cooked)'}, {'food_description': 'Per 101g - Calories: 263kcal | Fat: 12.25g | Carbs: 7.90g | Protein: 28.26g', 'food_id': '1818', 'food_name': 'Fried Chicken Liver', 'food_type': 'Generic', 'food_url': 'https://www.fatsecret.com/calories-nutrition/generic/chicken-liver-fried'}, {'food_description': 'Per 100g - Calories: 330kcal | Fat: 23.52g | Carbs: 8.70g | Protein: 19.82g', 'food_id': '34470', 'food_name': 'Chicken Neck Meat and Skin (Broilers or Fryers, Batter, Fried, Cooked)', 'food_type': 'Generic', 'food_url': 'https://www.fatsecret.com/calories-nutrition/usda/chicken-neck-meat-and-skin-(broilers-or-fryers-batter-fried-cooked)'}, {'food_description': 'Per 100g - Calories: 321kcal | Fat: 22.16g | Carbs: 2.39g | Protein: 26.11g', 'food_id': '34487', 'food_name': 'Chicken Wing Meat and Skin (Broilers or Fryers, Flour, Fried, Cooked)', 'food_type': 'Generic', 'food_url': 'https://www.fatsecret.com/calories-nutrition/usda/chicken-wing-meat-and-skin-(broilers-or-fryers-flour-fried-cooked)'}], 'max_results': '20', 'page_number': '0', 'total_results': '1999'}}
    """
    assert "foods" in res
    assert "food" in res["foods"]
    assert len(res["foods"]["food"]) > 0
    assert res["foods"]["food"][0]["food_name"] == "Korean Fried Chicken"


@pytest.mark.asyncio
async def test_chain_result():
    chain = build_search_chain(model="gpt-4o-mini")
    res = chain.invoke(  {"dish_name": "korean fried chicken" , "accept_language": "cn"})
    assert res is not None
    assert isinstance(res, Dish)


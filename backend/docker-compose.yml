services:
  fastapi-app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "${APP_PORT:-8000}:8000"
    environment:
      SECRET_KEY: ${SECRET_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:?required}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-https://api.openai.com/v1}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-5-nano}
      AZURE_DIP_API_KEY: ${AZURE_DIP_API_KEY:?required}
      AZURE_DIP_BASE_URL: ${AZURE_DIP_BASE_URL:?required}
      BACKEND_CORS_ORIGINS: ${BACKEND_CORS_ORIGINS:-[]}
      BACKEND_CORS_ORIGINS_REGEX: ${BACKEND_CORS_ORIGINS_REGEX:-}
      GOOGLE_IMG_SEARCH_URL: ${GOOGLE_IMG_SEARCH_URL:-https://www.googleapis.com/customsearch/v1}
      GOOGLE_IMG_SEARCH_CX: ${GOOGLE_IMG_SEARCH_CX:?required}
      GOOGLE_IMG_SEARCH_KEY: ${GOOGLE_IMG_SEARCH_KEY:?required}
      SUPABASE_URL: ${SUPABASE_URL:?required}
      SUPABASE_KEY: ${SUPABASE_KEY:?required}
      FATSECRET_TOKEN_URL: ${FATSECRET_TOKEN_URL:?required}
      FATSECRET_CLIENT_ID: ${FATSECRET_CLIENT_ID:?required}
      FATSECRET_CLIENT_SECRET: ${FATSECRET_CLIENT_SECRET:?required}
      FATSECRET_BASE_URL: ${FATSECRET_BASE_URL:?required}
      MENU_DEFAULT_FLOW_ID: ${MENU_DEFAULT_FLOW_ID:-dip.auto_group.v1}
      MENU_ENABLED_FLOW_IDS: ${MENU_ENABLED_FLOW_IDS:-dip.auto_group.v1,dip.lines_only.v1}
      MENU_FLOW_ALIASES: ${MENU_FLOW_ALIASES:-default=dip.auto_group.v1,legacy=dip.auto_group.v1,fast=dip.lines_only.v1}
      MENU_GROUPING_TIMEOUT_SECONDS: ${MENU_GROUPING_TIMEOUT_SECONDS:-8}
      MENU_GROUPING_LLM_LINE_THRESHOLD: ${MENU_GROUPING_LLM_LINE_THRESHOLD:-40}
      MENU_DISH_FANOUT_CONCURRENCY: ${MENU_DISH_FANOUT_CONCURRENCY:-12}
      MENU_DISH_FANOUT_ADAPTIVE: ${MENU_DISH_FANOUT_ADAPTIVE:-true}
      MENU_DISH_FANOUT_MAX_CONCURRENCY: ${MENU_DISH_FANOUT_MAX_CONCURRENCY:-100}
      MENU_IMAGE_ENRICH_MAX_ITEMS: ${MENU_IMAGE_ENRICH_MAX_ITEMS:-30}
      DEBUG_TOOLS_ENABLED: ${DEBUG_TOOLS_ENABLED:-false}
      BENCHMARK_OUTPUT_DIR: ${BENCHMARK_OUTPUT_DIR:-benchmark/output}
    restart: unless-stopped
